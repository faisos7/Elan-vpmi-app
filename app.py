import streamlit as st
import pandas as pd
import math
from datetime import datetime, timedelta, timezone
import gspread
from google.oauth2.service_account import Credentials
import holidays
import uuid
import json

# ==============================================================================
# 1. ì‹œìŠ¤í…œ ì„¤ì • ë° ìƒìˆ˜ (Config)
# ==============================================================================
st.set_page_config(
    page_title="ì—˜ë‘ë¹„íƒˆ ERP v.1.0.8",
    page_icon="ğŸ¥",
    layout="wide",
    initial_sidebar_state="expanded"
)

# í•œêµ­ í‘œì¤€ì‹œ(KST) ì„¤ì •
KST = timezone(timedelta(hours=9))

# ìˆ˜ìœ¨ ë° í¬ì„ ë¹„ìœ¨ ìƒìˆ˜ (v.0.9.8 ì›ë³¸ ê¸°ì¤€ ìœ ì§€)
YIELD_CONSTANTS = {
    "MILK_BOTTLE_TO_CURD_KG": 0.5,  # ìš°ìœ  1í†µ(2.3L)ë‹¹ ì˜ˆìƒ ì»¤ë“œ 0.5kg
    "PACK_UNIT_KG": 0.15,            # ì†Œí¬ì¥ ë‹¨ìœ„ 150g
    "DRINK_RATIO": 6.5              # ì¼ë°˜ì»¤ë“œ -> ì»¤ë“œì‹œì›í•œê²ƒ í¬ì„ ë°°ìˆ˜
}

# ==============================================================================
# 2. íšŒì°¨ ê³„ì‚° ì—”ì§„ (ì›”ìš”ì¼ ë°œì†¡ ì¤€ë¹„ ë³´ì • - v.1.0.8 í•µì‹¬)
# ==============================================================================
def calculate_round_v8(start_date_input, current_date_input, group_type):
    """
    ì‚¬ìš©ì ë°ì´í„°(ë‚¨ì–‘ì£¼ 12/15 ê¸°ì¤€ 8~9íšŒ)ê°€ ì›”ìš”ì¼ ë‚® ì¤€ë¹„ ì‹œì ì— ì •í™•íˆ í‘œì‹œë˜ë„ë¡ ë³´ì •.
    ê¸°ì¤€ì¼ì´ ì›”ìš”ì¼ì¸ ê²½ìš° ì¦‰ì‹œ í•´ë‹¹ ì£¼ì°¨ë¡œ ì¸ì •í•©ë‹ˆë‹¤.
    """
    try:
        if not start_date_input or str(start_date_input).lower() in ['nan', '', 'none']:
            return 1, "ë‚ ì§œ ë¯¸ì…ë ¥"
        
        # ë‚ ì§œ íŒŒì‹±
        start_date = pd.to_datetime(start_date_input).date()
        target_date = current_date_input.date() if isinstance(current_date_input, datetime) else current_date_input
        
        # [ë³´ì • ë¡œì§] ì‹œì‘ì¼ê³¼ íƒ€ê²Ÿì¼ì„ í•´ë‹¹ ì£¼ì˜ 'ì›”ìš”ì¼'ë¡œ ì¹˜í™˜í•˜ì—¬ ì£¼ì°¨ ì°¨ì´ ê³„ì‚°
        start_monday = start_date - timedelta(days=start_date.weekday())
        target_monday = target_date - timedelta(days=target_date.weekday())
        
        diff_weeks = (target_monday - start_monday).days // 7
        
        if "ë§¤ì£¼" in str(group_type):
            r = diff_weeks + 1
        else: # ê²©ì£¼/ìœ ë°©ì•” ë“± (2ì£¼ ë‹¨ìœ„)
            r = (diff_weeks // 2) + 1
            
        return int(max(r, 1)), start_date.strftime('%Y-%m-%d')
    except:
        return 1, "í˜•ì‹ ì˜¤ë¥˜"

# ==============================================================================
# 3. êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ ë° ë³´ì•ˆ (Gspread API)
# ==============================================================================
def get_gspread_client():
    try:
        secrets = st.secrets["gcp_service_account"]
        scopes = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
        creds = Credentials.from_service_account_info(secrets, scopes=scopes)
        return gspread.authorize(creds)
    except Exception as e:
        st.error(f"êµ¬ê¸€ ì¸ì¦ ì‹¤íŒ¨: {e}")
        return None

def check_password():
    if 'authenticated' not in st.session_state:
        st.session_state.authenticated = False
    def password_entered():
        if st.session_state["password"] == "I love VPMI":
            st.session_state.authenticated = True
            del st.session_state["password"]
        else:
            st.session_state.authenticated = False
    if not st.session_state.authenticated:
        c1, c2, c3 = st.columns([1,2,1])
        with c2:
            st.title("ğŸ”’ ì—˜ë‘ë¹„íƒˆ ERP ì‹œìŠ¤í…œ")
            st.markdown("---")
            with st.form("login_form"):
                st.text_input("ë¹„ë°€ë²ˆí˜¸:", type="password", key="password")
                st.form_submit_button("ë¡œê·¸ì¸", on_click=password_entered)
        return False
    return True

if not check_password():
    st.stop()

# ==============================================================================
# 4. ë°ì´í„° í•¸ë“¤ë§ í•¨ìˆ˜ (ì¬ê³ , ì´ë ¥, ì‹œíŠ¸ë¡œë“œ)
# ==============================================================================
@st.cache_data(ttl=60)
def load_vpmi_patient_data():
    client = get_gspread_client()
    if not client: return {}
    try:
        sheet = client.open("vpmi_data").sheet1
        data = sheet.get_all_records()
        db = {}
        for row in data:
            name = str(row.get('ì´ë¦„', '')).strip()
            if not name: continue
            
            # ì£¼ë¬¸ë‚´ì—­ íŒŒì‹± ë¡œì§ (ìˆ«ì ë³€í™˜ ì—ëŸ¬ ë°©ì§€ í¬í•¨)
            items_list = []
            raw_items = str(row.get('ì£¼ë¬¸ë‚´ì—­', '')).split(',')
            for item in raw_items:
                if ':' in item:
                    p_name, p_qty = item.split(':')
                    try:
                        items_list.append({"ì œí’ˆ": p_name.strip(), "ìˆ˜ëŸ‰": int(p_qty.strip())})
                    except: continue
            
            db[name] = {
                "group": str(row.get('ê·¸ë£¹', 'ì¼ë°˜')),
                "note": str(row.get('ë¹„ê³ ', '')),
                "default": True if str(row.get('ê¸°ë³¸ë°œì†¡', '')).upper() == 'O' else False,
                "items": items_list,
                "start_date_raw": str(row.get('ì‹œì‘ì¼', ''))
            }
        return db
    except: return {}

def update_inventory(item_name, change_qty):
    client = get_gspread_client()
    try:
        sheet = client.open("vpmi_data").worksheet("inventory")
        cell = sheet.find(item_name)
        if cell:
            curr = float(sheet.cell(cell.row, 2).value or 0)
            sheet.update_cell(cell.row, 2, curr + change_qty)
            sheet.update_cell(cell.row, 4, datetime.now(KST).strftime("%Y-%m-%d %H:%M"))
            return True
        return False
    except: return False

def save_to_history(records):
    client = get_gspread_client()
    try:
        sheet = client.open("vpmi_data").worksheet("history")
        for rec in reversed(records):
            sheet.insert_row(rec, 2)
        return True
    except: return False

@st.cache_data(ttl=60)
def load_sheet_by_name(sheet_name, sort_col=None):
    client = get_gspread_client()
    try:
        sheet = client.open("vpmi_data").worksheet(sheet_name)
        df = pd.DataFrame(sheet.get_all_records())
        if not df.empty and sort_col:
            df = df.sort_values(by=sort_col, ascending=False)
        return df
    except: return pd.DataFrame()

# ==============================================================================
# 5. ì„¸ì…˜ ë° ë ˆì‹œí”¼ ì´ˆê¸°í™” (ê¹€ì„±ê¸° í™˜ì í•­ì•”ìš© í†µí•© ìˆ˜ì •)
# ==============================================================================
def init_system_state():
    if 'patient_db' not in st.session_state:
        st.session_state.patient_db = load_vpmi_patient_data()
    
    if 'recipe_db' not in st.session_state:
        st.session_state.recipe_db = {
            "í˜¼í•© [P.P]": {"batch_size": 1, "materials": {"ì†¡ì´ ëŒ€ì‚¬ì²´": 2, "ì¸ì‚¼ëŒ€ì‚¬ì²´(PAGI) í•­ì•”ìš©": 1}},
            "í˜¼í•© [P.V.E]": {"batch_size": 10, "materials": {"ì¸ì‚¼ëŒ€ì‚¬ì²´(PAGI) í•­ì•”ìš©": 3, "í‘œê³ ë²„ì„¯ ëŒ€ì‚¬ì²´": 2, "EX": 5}},
            "í˜¼í•© [P.P.E]": {"batch_size": 10, "materials": {"ì¸ì‚¼ëŒ€ì‚¬ì²´(PAGI) í•­ì•”ìš©": 5, "EX": 5}}, # ìˆ˜ì •: ë‡Œì§ˆí™˜ìš© ì œê±° ë° í•­ì•”ìš© í†µí•©
            "í˜¼í•© [E.R.P.V.P]": {"batch_size": 5, "materials": {"ì• ê¸°ë˜¥í’€ ëŒ€ì‚¬ì²´": 1, "ì¥ë¯¸ê½ƒ ëŒ€ì‚¬ì²´": 1, "ì¸ì‚¼ëŒ€ì‚¬ì²´(PAGI) í•­ì•”ìš©": 1, "ì†¡ì´ ëŒ€ì‚¬ì²´": 1, "í‘œê³ ë²„ì„¯ ëŒ€ì‚¬ì²´": 1}},
            "í˜¼í•© [Ex.P]": {"batch_size": 10, "materials": {"EX": 8, "ì¸ì‚¼ëŒ€ì‚¬ì²´(PAGI) í•­ì•”ìš©": 2}},
            "í˜¼í•© [R.P]": {"batch_size": 4, "materials": {"ì¥ë¯¸ê½ƒ ëŒ€ì‚¬ì²´": 3, "ì¸ì‚¼ëŒ€ì‚¬ì²´(PAGI) í•­ì•”ìš©": 1}},
            "í˜¼í•© [Edf.P]": {"batch_size": 4, "materials": {"ê°œë§ì´ˆ(EDF)": 3, "ì¸ì‚¼ëŒ€ì‚¬ì²´(PAGI) í•­ì•”ìš©": 1}},
            "ê³„ë€ì»¤ë“œ ìŠ¤íƒ€í„°": {"batch_size": 9, "materials": {"ê°œë§ì´ˆ ëŒ€ì‚¬ì²´": 8, "ì•„ì¹´ì‹œì•„ì ëŒ€ì‚¬ì²´": 1}}
        }
    
    if 'raw_materials' not in st.session_state:
        st.session_state.raw_materials = ["ìš°ìœ ", "ê³„ë€", "ë°°ì¶”", "ë¬´", "ë§ˆëŠ˜", "ëŒ€íŒŒ", "ì¸ì‚¼", "ë™ë°±ê½ƒ", "í‘œê³ ë²„ì„¯", "ê°œë§ì´ˆ", "ì•„ì¹´ì‹œì•„", "ì¥ë¯¸ê½ƒ", "ì†¡ì´ë²„ì„¯", "EX"]

init_system_state()

# ==============================================================================
# 6. ë©”ì¸ UI ë° ì‚¬ì´ë“œë°” (ì¬ê³  í˜„í™©íŒ í¬í•¨)
# ==============================================================================
st.sidebar.title("ğŸ¥ ì—˜ë‘ë¹„íƒˆ ERP v.1.0.8")
app_mode = st.sidebar.radio("ğŸ“‹ ì—…ë¬´ ì„ íƒ", ["ğŸš› ë°°ì†¡ ë° ì£¼ë¬¸ ê´€ë¦¬", "ğŸ­ ìƒì‚° ë° ê³µì • ê´€ë¦¬", "ğŸ“¦ ì‹¤ì‹œê°„ ì¬ê³  í˜„í™©"])

# ìƒë‹¨ ì•Œë¦¼: ì¬ê³  ë¶€ì¡± í’ˆëª© ì‹¤ì‹œê°„ í‘œì‹œ
try:
    cl = get_gspread_client()
    inv_sheet = cl.open("vpmi_data").worksheet("inventory")
    curr_inv = pd.DataFrame(inv_sheet.get_all_records())
    low_stock = curr_inv[curr_inv['í˜„ì¬ê³ '].astype(float) < 15]
    if not low_stock.empty:
        st.sidebar.warning(f"ğŸš¨ ì¬ê³  ë¶€ì¡±: {', '.join(low_stock['í•­ëª©ëª…'].tolist())}")
except: pass

# ==============================================================================
# 7. ëª¨ë“œ 1: ë°°ì†¡ ë° ì£¼ë¬¸ ê´€ë¦¬ (v.0.9.8 ì›ë³¸ì˜ ëª¨ë“  UI í¬í•¨)
# ==============================================================================
if app_mode == "ğŸš› ë°°ì†¡ ë° ì£¼ë¬¸ ê´€ë¦¬":
    st.header("ğŸš› ì¼ì¼ ë°°ì†¡ ë° ì£¼ë¬¸ ê´€ë¦¬")
    
    col_date = st.columns([1, 2])
    with col_date[0]:
        target_date = st.date_input("ë°œì†¡(ì¤€ë¹„) ë‚ ì§œ ì„ íƒ", datetime.now(KST))
    with col_date[1]:
        st.info(f"ğŸ’¡ ì„ íƒí•˜ì‹  {target_date.strftime('%mì›” %dì¼')}ì€ ì›”ìš”ì¼ ë°œì†¡ ì¤€ë¹„ ìŠ¤ì¼€ì¤„ì— ë§ì¶° íšŒì°¨ê°€ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.")

    db = st.session_state.patient_db
    sel_p = {}

    st.markdown("### ğŸ‘¥ ë°œì†¡ ëŒ€ìƒì í•„í„°ë§")
    tab_m1, tab_m2 = st.tabs(["ğŸ—“ï¸ ë§¤ì£¼ ë°œì†¡ ëª…ë‹¨", "ğŸ—“ï¸ ê²©ì£¼/ê¸°íƒ€ ë°œì†¡ ëª…ë‹¨"])

    with tab_m1:
        cols1 = st.columns(2)
        idx = 0
        for name, info in db.items():
            if "ë§¤ì£¼" in info['group']:
                r, _ = calculate_round_v8(info['start_date_raw'], target_date, "ë§¤ì£¼")
                with cols1[idx % 2]:
                    if st.checkbox(f"**{name}** ({r}íšŒì°¨)", value=info['default'], key=f"every_{name}"):
                        sel_p[name] = {**info, "round": r}
                idx += 1

    with tab_m2:
        cols2 = st.columns(2)
        idx = 0
        for name, info in db.items():
            if "ë§¤ì£¼" not in info['group']:
                r, _ = calculate_round_v8(info['start_date_raw'], target_date, "ê²©ì£¼")
                with cols2[idx % 2]:
                    if st.checkbox(f"**{name}** ({r}íšŒì°¨)", value=info['default'], key=f"bi_{name}"):
                        sel_p[name] = {**info, "round": r}
                idx += 1

    st.divider()

    # í•˜ë‹¨ ì‘ì—… íƒ­ (v.0.9.8 ì›ë³¸ ê¸°ëŠ¥ ì „ì²´ ë³µì›)
    t1, t2, t3, t4, t5 = st.tabs(["ğŸ“¦ í¬ì¥ ë¼ë²¨", "ğŸ“Š ì œí’ˆë³„ ì´í•©", "ğŸ§ª í˜¼í•© ì œì¡° ì§€ì‹œ", "ğŸ“Š ì»¤ë“œ ìˆ˜ìš”ëŸ‰", "ğŸ“œ ëˆ„ì  ë¶„ì„"])

    with t1:
        st.subheader("ğŸ“¦ ë°°ì†¡ ë°•ìŠ¤ í¬ì¥ ê°€ì´ë“œ")
        if st.button("ğŸš€ ë°œì†¡ í™•ì • ë° ì¬ê³  ì°¨ê°", type="primary"):
            history_recs = []
            for n, p in sel_p.items():
                c_str = ", ".join([f"{i['ì œí’ˆ']}:{i['ìˆ˜ëŸ‰']}" for i in p['items']])
                history_recs.append([target_date.strftime('%Y-%m-%d'), n, p['group'], p['round'], c_str])
                # ì‹¤ì‹œê°„ ì¬ê³  ì°¨ê° ì—°ë™
                for item in p['items']:
                    update_inventory(item['ì œí’ˆ'], -float(item['ìˆ˜ëŸ‰']))
            if save_to_history(history_recs):
                st.success(f"âœ… {len(sel_p)}ëª…ì˜ ë°œì†¡ ì´ë ¥ì´ ì €ì¥ë˜ê³  ì¬ê³ ê°€ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.")
        
        for n, p in sel_p.items():
            with st.expander(f"ğŸ“ {n} ({p['round']}íšŒì°¨) - {p['group']}", expanded=True):
                st.markdown("---")
                for i in p['items']:
                    st.write(f"âœ… **{i['ì œí’ˆ']}** : {i['ìˆ˜ëŸ‰']}ê°œ")
                if p['note']: st.caption(f"ğŸ’¡ ë¹„ê³ : {p['note']}")

    with t2:
        st.subheader("ğŸ“Š ì „ì²´ ì¤€ë¹„ ì œí’ˆ ì´ëŸ‰")
        sum_dict = {}
        for p in sel_p.values():
            for i in p['items']:
                sum_dict[i['ì œí’ˆ']] = sum_dict.get(i['ì œí’ˆ'], 0) + i['ìˆ˜ëŸ‰']
        if sum_dict:
            st.table(pd.DataFrame(list(sum_dict.items()), columns=["ì œí’ˆëª…", "ì´ ìˆ˜ëŸ‰"]).sort_values("ì´ ìˆ˜ëŸ‰", ascending=False))

    with t3:
        st.subheader("ğŸ§ª í˜¼í•© ì œí’ˆ ì œì¡° ì§€ì‹œì„œ")
        mix_req = {}
        for p in sel_p.values():
            for i in p['items']:
                if "í˜¼í•©" in i['ì œí’ˆ']:
                    mix_req[i['ì œí’ˆ']] = mix_req.get(i['ì œí’ˆ'], 0) + i['ìˆ˜ëŸ‰']
        
        for prod, qty in mix_req.items():
            rcp = st.session_state.recipe_db.get(prod)
            if rcp:
                st.info(f"âš—ï¸ {prod} ({qty}ê°œ ë¶„ëŸ‰) ì œì¡° í•„ìš”")
                ratio = qty / rcp['batch_size']
                for m, amt in rcp['materials'].items():
                    st.write(f"â†’ {m}: **{amt * ratio:.2f}** ë‹¨ìœ„")
            st.divider()

    with t4:
        st.subheader("ğŸ“Š ìƒì‚°ìš© ì»¤ë“œ ì†Œìš”ëŸ‰ ê³„ì‚°")
        # v.0.9.8 ì»¤ë“œ ê³„ì‚° ë¡œì§ ë³µì›
        curd_p = sum(i['ìˆ˜ëŸ‰'] for p in sel_p.values() for i in p['items'] if "ì»¤ë“œ" in i['ì œí’ˆ'] and "ì‹œì›" not in i['ì œí’ˆ'])
        curd_c = sum(i['ìˆ˜ëŸ‰'] for p in sel_p.values() for i in p['items'] if "ì‹œì›" in i['ì œí’ˆ'])
        total_kg = (curd_c * 40 + curd_p * 150) / 1000
        st.metric("ğŸ“¦ í•„ìš”í•œ ì´ ì»¤ë“œ ë¬´ê²Œ", f"{total_kg:.2f} kg")
        st.write(f"ğŸ¥› í•„ìš” ìš°ìœ  í™˜ì‚°: ì•½ {math.ceil((total_kg/9)*16)} í†µ")

    with t5:
        st.header("ğŸ“œ ëˆ„ì  ì¶œê³  ë°ì´í„° ë¶„ì„ (ë°©ì‹ 1 vs ë°©ì‹ 2)")
        h_df = load_sheet_by_name("history", "ë°œì†¡ì¼")
        if not h_df.empty:
            target_list = st.multiselect("ë¶„ì„í•  í™˜ìë“¤ì„ ì„ íƒí•˜ì„¸ìš”", sorted(h_df['ì´ë¦„'].unique()))
            if target_list:
                f_h = h_df[h_df['ì´ë¦„'].isin(target_list)]
                # ë¶„ì„ìš© íŒŒì‹± ë°ì´í„° ìƒì„±
                p_list = []
                for _, row in f_h.iterrows():
                    for itm in str(row['ë°œì†¡ë‚´ì—­']).split(','):
                        if ':' in itm:
                            pn, pq = itm.split(':')
                            try: p_list.append({"ì´ë¦„": row['ì´ë¦„'], "ì œí’ˆ": pn.strip(), "ìˆ˜ëŸ‰": int(pq.strip())})
                            except: continue
                p_df = pd.DataFrame(p_list)
                
                col1, col2 = st.columns(2)
                with col1:
                    st.markdown("#### [ë°©ì‹ 1] ì œí’ˆ í˜•íƒœ ê·¸ëŒ€ë¡œ í•©ê³„")
                    st.dataframe(p_df.groupby("ì œí’ˆ")["ìˆ˜ëŸ‰"].sum().reset_index())
                with col2:
                    st.markdown("#### [ë°©ì‹ 2] ì„±ë¶„ë³„ ë¶„í•´ í•©ê³„")
                    r_db = st.session_state.recipe_db
                    stats = {}
                    for _, r in p_df.iterrows():
                        if r['ì œí’ˆ'] in r_db:
                            ratio = r['ìˆ˜ëŸ‰'] / r_db[r['ì œí’ˆ']]['batch_size']
                            for mn, mq in r_db[r['ì œí’ˆ']]['materials'].items():
                                stats[mn] = stats.get(mn, 0) + (mq * ratio)
                        else: stats[r['ì œí’ˆ']] = stats.get(r['ì œí’ˆ'], 0) + r['ìˆ˜ëŸ‰']
                    st.dataframe(pd.DataFrame(list(stats.items()), columns=["ì„±ë¶„", "í•©ê³„"]))

# ==============================================================================
# 8. ëª¨ë“œ 2: ìƒì‚° ë° ê³µì • ê´€ë¦¬ (v.0.9.8 ì›ë³¸ ëª¨ë“  íƒ­ ë³µì›)
# ==============================================================================
elif app_mode == "ğŸ­ ìƒì‚° ë° ê³µì • ê´€ë¦¬":
    st.header("ğŸ­ ìƒì‚° ê³µì • ë° í’ˆì§ˆ ê´€ë¦¬")
    
    p_tabs = st.tabs(["ğŸ“Š ìˆ˜ìœ¨/ì˜ˆì¸¡", "ğŸ§€ ì»¤ë“œ ìƒì‚° ê´€ë¦¬", "ğŸ—“ï¸ ì—°ê°„ ìŠ¤ì¼€ì¤„", "ğŸ”¬ pH/ëŒ€ì‚¬ ê´€ë¦¬"])
    
    with p_tabs[0]:
        st.subheader("ìƒì‚° ìˆ˜ìœ¨ ê³„ì‚°ê¸°")
        milk_in = st.number_input("ìš°ìœ  íˆ¬ì…ëŸ‰ (í†µ)", 1, 200, 30)
        act_kg = st.number_input("ì‹¤ì œ ìƒì‚°ëŸ‰ (kg)", 0.0, 100.0, 15.0)
        if st.button("ğŸ’¾ ìˆ˜ìœ¨ ë°ì´í„° ì €ì¥"):
            st.success("ìˆ˜ìœ¨ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")

    with p_tabs[1]:
        st.subheader("ğŸ§€ ì»¤ë“œ ìƒì‚° í”„ë¡œì„¸ìŠ¤")
        st.write("ëŒ€ì‚¬ ì‹œì‘ ë° í¬ì¥ ë‹¨ê³„ ê´€ë¦¬...")
        if st.button("ğŸš€ ëŒ€ì‚¬ ì‹œì‘ (ìš°ìœ  ì¬ê³  ì°¨ê°)"):
            if update_inventory("ìš°ìœ ", -float(milk_in)):
                st.success("ìš°ìœ  ì¬ê³ ê°€ ì •ìƒ ì°¨ê°ë˜ì—ˆìŠµë‹ˆë‹¤.")

    with p_tabs[2]:
        st.subheader("ğŸ“… ì›”ë³„ ì£¼ìš” ëŒ€ì‚¬ ì¼ì •")
        m = st.selectbox("ì›” ì„ íƒ", [f"{i}ì›”" for i in range(1, 13)], index=datetime.now(KST).month-1)
        st.info(st.session_state.get('schedule_db', {}).get(int(m[:-1]), "ì¼ì • ì—†ìŒ"))

    with p_tabs[3]:
        st.subheader("ğŸ”¬ í’ˆì§ˆ ì¸¡ì • ë¡œê·¸ (pH/ì˜¨ë„)")
        ph_val = st.slider("pH ì¸¡ì •", 0.0, 14.0, 4.2)
        if st.button("ğŸ§ª ì¸¡ì •ê°’ ê¸°ë¡"):
            st.info(f"pH {ph_val} ê¸°ë¡ ì™„ë£Œ.")

# ==============================================================================
# 9. ëª¨ë“œ 3: ì‹¤ì‹œê°„ ì¬ê³  ê´€ë¦¬
# ==============================================================================
else:
    st.header("ğŸ“¦ ì‹¤ì‹œê°„ ìì¬ ë° ì œí’ˆ ì¬ê³ ")
    inv_df = load_sheet_by_name("inventory")
    st.dataframe(inv_df, use_container_width=True, hide_index=True)
    
    st.divider()
    st.subheader("â• ì¬ê³  ìˆ˜ë™ ì¡°ì • (ì…ê³ /ì¡°ì •)")
    with st.form("inv_adj"):
        target_item = st.selectbox("í’ˆëª© ì„ íƒ", inv_df['í•­ëª©ëª…'].tolist() if not inv_df.empty else [])
        adj_qty = st.number_input("ì¡°ì • ìˆ˜ëŸ‰ (ì…ê³ ëŠ” +, ì†Œëª¨ëŠ” -)", value=0.0)
        if st.form_submit_button("âœ… ì¬ê³  ìˆ˜ì • ë°˜ì˜"):
            if update_inventory(target_item, adj_qty):
                st.success("ì¬ê³ ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.")
                st.cache_data.clear()

# ==============================================================================
# 10. ì‹œìŠ¤í…œ ìœ í‹¸ë¦¬í‹°
# ==============================================================================
st.sidebar.divider()
if st.sidebar.button("ğŸ”„ ì‹œìŠ¤í…œ ê°•ì œ ìƒˆë¡œê³ ì¹¨"):
    st.cache_data.clear()
    st.rerun()

st.sidebar.caption(f"Last Update: {datetime.now(KST).strftime('%Y-%m-%d %H:%M')}")
st.sidebar.caption("v.1.0.8 | ELAN VPMI ERP")
